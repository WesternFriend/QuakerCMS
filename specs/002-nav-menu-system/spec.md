# Feature Specification: Multi-lingual Navigation Menu System

**Feature Branch**: `002-nav-menu-system`
**Created**: 2025-10-26
**Status**: Draft
**Input**: User description: "We need to allow users to define a navigation menu, similar to the WordPress menu system. They will select pages that will become menu links, using the page title or an optional alias. The menu items may be nested, but top-level items in the nested menu should only cause the menu to open. So, we need our menu system to support adding pages or submenus. A further complication but necessary requirement will be multi-lingual menu support. One option would be that each menu page would be selected in the default locale. Then, the locale-specific menus would be auto-generated by finding the equivalent item that links to the selected page. However, this may lead to complications in partially translated sites, where there aren't matching pages in the user locale. In that case, it might make sense to fall back to the default page, since it is guaranteed to exist."

## Design Philosophy

This feature prioritizes **simplicity over flexibility** to serve Quaker meetings and worship groups who need to focus on content rather than technical configuration. Unlike WordPress's multi-menu system, QuakerCMS provides a single, site-wide navigation menu that covers the primary use case without requiring users to understand concepts like "menu locations" or "menu assignment." This intentional constraint reduces cognitive load and administrative overhead while still delivering full multi-lingual support and nested menu capabilities.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Create Basic Navigation Menu (Priority: P1)

As a site administrator, I need to create a simple navigation menu with top-level pages so that visitors can navigate the site's main sections.

**Why this priority**: This is the foundation of the navigation system. Without the ability to create a basic menu with page links, no other menu functionality is possible. This delivers immediate value by enabling basic site navigation.

**Independent Test**: Can be fully tested by creating a menu with 3-5 top-level page links in the admin interface, saving it, and verifying the menu displays on the front-end with correct links and labels.

**Acceptance Scenarios**:

1. **Given** I am logged into the admin interface, **When** I navigate to Settings â†’ Navigation Menu, **Then** I see the navigation menu editor
2. **Given** I am creating a new menu, **When** I add a page to the menu without providing a custom title, **Then** the page's own title appears as the menu item label
3. **Given** I am adding a page to the menu, **When** I provide a custom title, **Then** I can optionally add translations for that title in enabled locales
4. **Given** I have added a custom title without translations, **When** visitors view the menu in any locale, **Then** the custom title displays as-is (same text for all locales)
5. **Given** I have added a custom title with translations for some locales, **When** a visitor views the menu in a locale with a translation, **Then** the translated title displays
6. **Given** I have added a custom title with translations, **When** a visitor views the menu in a locale without a translation, **Then** the default custom title displays
7. **Given** I have created a menu with multiple items, **When** I save the menu, **Then** the menu appears on the front-end in the order I specified
8. **Given** a visitor clicks a menu item, **When** the page loads, **Then** they navigate to the correct page

---

### User Story 2 - Organize Nested Menu Structure (Priority: P2)

As a site administrator, I need to create nested menu structures with submenus so that I can organize related pages hierarchically and reduce visual clutter.

**Why this priority**: Nested menus are essential for sites with many pages, but they build upon the basic menu functionality. This can be developed after the core menu system works.

**Independent Test**: Can be fully tested by creating a menu with at least one top-level item that has 3+ child items, verifying the submenu opens on hover/click, and confirming child items navigate correctly.

**Acceptance Scenarios**:

1. **Given** I am editing a menu, **When** I add a dropdown menu item, **Then** I can add page links and external links within that dropdown
2. **Given** I am creating a dropdown menu, **When** I set the dropdown title, **Then** I can provide translations for that title in all enabled locales
3. **Given** I have created a nested menu structure, **When** I save the menu, **Then** the hierarchy is preserved on the front-end
4. **Given** a visitor views a menu with dropdown items, **When** they hover over or click a dropdown menu item, **Then** the submenu expands to show child items
5. **Given** a visitor views a dropdown menu in a specific locale, **When** the dropdown has a title translation for that locale, **Then** the translated title displays
6. **Given** a dropdown menu item exists, **When** a visitor clicks the dropdown menu title itself, **Then** it only opens the submenu without navigating (the dropdown title is not clickable as a link)
7. **Given** I want to reorder menu items, **When** I use the up/down arrow controls in the admin interface, **Then** the menu items move to the new position
8. **Given** I have reordered menu items, **When** I save the menu, **Then** the new order is preserved on the front-end
9. **Given** I try to add a dropdown menu inside another dropdown menu, **When** I attempt to save, **Then** the system prevents this and shows a validation error (maximum 2 levels enforced)
10. **Given** a dropdown menu is positioned near the right edge of the screen, **When** a visitor opens it, **Then** the submenu opens to the left to prevent horizontal overflow
11. **Given** a dropdown menu is positioned near the left edge of the screen, **When** a visitor opens it, **Then** the submenu opens to the right to remain visible
12. **Given** a dropdown menu has sufficient space in all directions, **When** a visitor opens it, **Then** the submenu opens downward by default

---

### User Story 3 - Multi-lingual Menu Auto-generation (Priority: P3)

As a site administrator, I need menus to automatically adapt to the visitor's language while falling back gracefully when translations are missing, so that visitors have consistent navigation regardless of their language preference.

**Why this priority**: Multi-lingual support is important for international sites, but the core menu system must work first. This is an enhancement that builds on P1 and P2 functionality.

**Independent Test**: Can be fully tested by creating a menu in the default locale with 5 pages (3 fully translated, 2 untranslated), switching to a non-default locale, and verifying that translated pages show locale-specific versions while untranslated pages link to default locale versions.

**Acceptance Scenarios**:

1. **Given** I create a menu in the default locale (e.g., English), **When** I select pages for menu items, **Then** the system records these as the canonical menu structure
2. **Given** I create a menu item with a custom label, **When** I provide translations for that label, **Then** the system stores the label translations for each enabled locale
3. **Given** a menu exists in the default locale, **When** a visitor views the site in a different locale (e.g., Spanish), **Then** the menu structure automatically displays with locale-appropriate page links and labels
4. **Given** a menu item has a custom label translation in the visitor's locale, **When** the visitor views the menu, **Then** the custom label translation displays
5. **Given** a menu item has no custom label translation in the visitor's locale, **When** the visitor views the menu, **Then** the system uses the translated page title (or falls back to default locale page title if no page translation exists)
6. **Given** a menu item links to a page with a translation in the visitor's locale, **When** the visitor views the menu, **Then** the menu item links to the translated page
7. **Given** a menu item links to a page without a translation in the visitor's locale, **When** the visitor views the menu, **Then** the menu item links to the default locale version of the page
8. **Given** a partially translated site, **When** a visitor navigates using the menu, **Then** they experience seamless navigation even when some pages fall back to the default language
9. **Given** I update a page's translation, **When** the menu regenerates for that locale, **Then** the menu item automatically updates to link to the new translation

---

### User Story 4 - Accessible Navigation for All Users (Priority: P1)

As a visitor using assistive technology (screen reader, keyboard-only, or mobile device), I need the navigation menu to be fully accessible so that I can navigate the site independently regardless of my abilities or device.

**Why this priority**: Accessibility is a legal requirement (ADA, Section 508) and ethical obligation, not a nice-to-have feature. This must be built into the foundation from day one, not retrofitted later. Affects 15-20% of users (disabilities, mobile users, keyboard-only users).

**Independent Test**: Can be fully tested by:

1. Using NVDA/JAWS screen reader to navigate menu and verify proper announcements
2. Using only keyboard (no mouse) to open dropdowns and activate all links
3. Testing with JavaScript disabled to verify `<details>`/`<summary>` fallback
4. Running automated accessibility scan (axe DevTools) to verify WCAG 2.1 AA compliance
5. Testing on mobile device to verify touch target sizes and hamburger menu
6. Testing in dark/light themes to verify proper contrast ratios

**Acceptance Scenarios**:

1. **Given** I am a keyboard-only user, **When** I press Tab key, **Then** I can navigate through all menu items with visible focus indicators
2. **Given** I am on a dropdown menu item, **When** I press Enter or Space, **Then** the dropdown opens and focus moves to first child item
3. **Given** I have a dropdown open, **When** I press Escape, **Then** the dropdown closes and focus returns to the parent trigger
4. **Given** I am using a screen reader, **When** I encounter a dropdown menu, **Then** I hear "menu item, has submenu" or similar announcement
5. **Given** I am using a screen reader, **When** I navigate to a menu item, **Then** I hear the item's position (e.g., "item 2 of 5") and current state
6. **Given** I am on the current page, **When** I navigate the menu, **Then** the corresponding menu item is announced as "current page"
7. **Given** I am on a mobile device, **When** I tap the hamburger menu button, **Then** the button has sufficient touch target size (44x44 pixels minimum) and the menu opens
8. **Given** I have JavaScript disabled, **When** I click a dropdown menu, **Then** the dropdown still expands using native `<details>` element behavior
9. **Given** I am using the site in dark mode, **When** the menu renders, **Then** all text and interactive elements have sufficient contrast (4.5:1 minimum)
10. **Given** I am at the top of the page, **When** I press Tab, **Then** the first focusable element is a "Skip to main content" link
11. **Given** I use the skip link, **When** I activate it, **Then** focus moves to the main content area, bypassing the navigation menu
12. **Given** I am a color-blind user, **When** I hover over menu items, **Then** I can distinguish hover states through multiple visual indicators (not just color)

---

### Edge Cases

- What happens when a page linked in a menu is deleted? (Menu item should show warning in admin, optionally remove from front-end or show as disabled)
- What happens when a menu has no items? (Menu section should not display on front-end, or show empty state message)
- How are menu items ordered when new items are added? (Default to bottom of current level, allow reordering via up/down arrows)
- What happens when a locale is deleted? (Menu items automatically fall back to default locale for that language)
- How does the system handle pages that exist in some locales but not the default locale? (This violates the assumed pattern - default locale should have all pages, only allow linking pages that exist in default locale)
- What happens when an external URL becomes invalid? (System cannot validate external URLs, administrator responsible for maintaining valid links)
- How are anchor links validated? (Anchors are not validated, administrator responsible for ensuring target anchors exist on the page)
- What happens when a custom title translation is missing for a locale? (Fall back to the default custom title text)
- What happens when no custom title is provided? (Use the page's own translated title, falling back to default locale title if page not translated)
- How are custom title translations stored? (As optional locale-text pairs within each menu item - only needed when overriding page titles)
- What about additional menus (footer, sidebar)? (Out of scope for this feature - this implements the primary navigation menu only; additional menus can be added as separate settings in future features)
- What happens if an administrator tries to create a 3-level nested menu? (System must prevent this in the admin interface - dropdown blocks cannot contain other dropdown blocks, only simple link blocks)
- What if a dropdown menu would extend beyond the viewport? (Frontend implements edge detection: menus near right edge open left, menus near left edge open right, default opens down)
- How does edge detection work on mobile devices? (Same logic applies but with smaller viewport - menus adapt to available space using responsive positioning)
- What happens when the viewport is resized while a menu is open? (Menu position should recalculate and adjust if needed, or close and require reopening)
- How does keyboard navigation work with nested dropdowns? (Tab moves between top-level items, Enter/Space opens dropdowns, Arrow keys navigate within dropdowns, Escape closes dropdowns)
- What happens if JavaScript is disabled? (Navigation remains functional using `<details>`/`<summary>` elements for progressive enhancement)
- How does dark mode affect menu styling? (Menu uses DaisyUI theme-aware classes like `bg-base-100` that automatically adapt to theme)
- How is the current page indicated in the menu? (Active menu item receives `aria-current="page"` attribute and visual styling via CSS)
- What happens on mobile devices with small screens? (Navigation collapses to hamburger menu at < 1024px breakpoint using DaisyUI responsive classes)
- How are touch targets sized for mobile accessibility? (All interactive elements have minimum 44x44 pixel touch targets per WCAG guidelines)
- How do screen readers announce dropdown menus? (Dropdown triggers use `aria-haspopup="true"` and submenus have `aria-labelledby` for proper context)
- What if a color-blind user can't distinguish hover states? (Hover/focus states use multiple visual indicators: underline, background color, and border changes - not color alone)

## Requirements *(mandatory)*

### Functional Requirements

#### Backend & Data Management

- **FR-001**: System MUST provide a site-wide navigation menu accessible via Settings in the admin interface
- **FR-002**: System MUST allow administrators to add menu items by selecting from available pages or entering external URLs
- **FR-003**: System MUST use the page's own title as the default menu item label when no custom title is provided
- **FR-004**: System MUST allow administrators to optionally provide a custom title for menu items
- **FR-005**: System MUST allow administrators to optionally add translations for custom titles in enabled locales
- **FR-006**: System MUST display the page's translated title when no custom title is provided and a page translation exists
- **FR-007**: System MUST display the custom title (or its translation if available) when a custom title is provided
- **FR-008**: System MUST support both internal page links and external URL links as menu items
- **FR-009**: System MUST support dropdown menu items that contain multiple child links (pages or external URLs)
- **FR-010**: System MUST allow administrators to optionally provide translations for external link titles and dropdown menu titles
- **FR-011**: System MUST allow administrators to reorder menu items using up/down arrow controls
- **FR-012**: System MUST support optional anchor links (fragment identifiers) for both internal pages and external URLs
- **FR-013**: System MUST limit menu nesting to exactly 2 levels: top-level items can be simple links OR dropdown menus; dropdown menus can ONLY contain simple links (no nested dropdowns)
- **FR-013a**: System MUST prevent administrators from adding dropdown menus within dropdown menus (enforce 2-level maximum in admin interface)
- **FR-014**: Dropdown menu items MUST NOT navigate when clicked - they MUST only expand/collapse the submenu
- **FR-015**: Simple link menu items (both top-level and within dropdowns) MUST navigate to their target when clicked
- **FR-016**: System MUST store menu structure in the default locale as the canonical source
- **FR-017**: System MUST automatically display locale-appropriate menu labels based on available translations
- **FR-018**: System MUST link to translated page versions when available in the visitor's locale
- **FR-019**: System MUST fall back to the default locale page when no translation exists in the visitor's locale
- **FR-020**: System MUST preserve menu item order and hierarchy when rendering in different locales
- **FR-021**: System MUST update menu display when page translations are added or removed
- **FR-022**: System MUST warn administrators when a menu item links to a deleted page
- **FR-023**: System MUST allow administrators to delete menu items
- **FR-024**: System MUST save menu changes only when administrator explicitly saves

#### Frontend Rendering & Accessibility (WCAG 2.1 AA Compliance)

- **FR-025**: Navigation menu MUST use semantic HTML5 `<nav>` element with appropriate ARIA landmark role
- **FR-026**: Navigation menu MUST include accessible name via `aria-label` or `aria-labelledby` (e.g., "Main navigation")
- **FR-027**: Menu list items MUST use `role="none"` to remove default list semantics when using ARIA menu pattern
- **FR-028**: Simple menu links MUST use `role="menuitem"` for proper screen reader announcement
- **FR-029**: Dropdown menu triggers MUST use `role="menuitem"` with `aria-haspopup="true"` and `aria-controls` pointing to submenu ID
- **FR-030**: Dropdown submenus MUST use `role="menu"` with unique IDs referenced by parent's `aria-controls`
- **FR-031**: Dropdown submenus MUST use `aria-labelledby` pointing to parent trigger's ID for proper context
- **FR-032**: Navigation menu MUST support full keyboard navigation:
  - Tab/Shift+Tab to navigate between top-level items
  - Enter/Space to activate links or toggle dropdowns
  - Escape to close open dropdowns
  - Arrow keys (down/up) to navigate within dropdowns
- **FR-033**: Focus states MUST be clearly visible with sufficient contrast (3:1 ratio minimum)
- **FR-034**: Active/current page MUST be indicated with `aria-current="page"` attribute
- **FR-035**: Navigation MUST render using DaisyUI theme-aware classes for automatic dark/light mode support
- **FR-036**: Dropdown menus MUST use theme-aware background colors (e.g., `bg-base-100` instead of hardcoded `bg-white`)
- **FR-037**: Navigation MUST be responsive with mobile-friendly hamburger menu for screens < 1024px (lg breakpoint)
- **FR-038**: Mobile hamburger menu MUST use accessible button with `aria-expanded` state
- **FR-039**: Navigation MUST provide skip link for keyboard users to bypass menu and jump to main content
- **FR-040**: Dropdown menus SHOULD use `<details>`/`<summary>` elements for progressive enhancement (works without JavaScript)
- **FR-041**: Navigation templates MUST be structured as reusable components:
  - `navigation.html` - Main navigation wrapper
  - `navigation_item.html` - Simple link rendering
  - `navigation_dropdown.html` - Dropdown menu rendering
- **FR-042**: Navigation component MUST be included in `base.html` template for site-wide availability
- **FR-043**: Menu links MUST have minimum touch target size of 44x44 pixels for mobile accessibility
- **FR-044**: Color contrast MUST meet WCAG AA standards (4.5:1 for normal text, 3:1 for large text)
- **FR-045**: Hover and focus states MUST have distinct visual indicators beyond color alone
- **FR-046**: Dropdown menus MUST implement edge detection to prevent overflow: menus near the right screen edge MUST open to the left, menus near the left edge MUST open to the right
- **FR-047**: Dropdown menu positioning MUST be responsive and adapt to viewport size changes
- **FR-048**: Dropdown menus MUST have a default drop-down direction when sufficient space exists in all directions

### Key Entities

- **NavigationMenuSetting**: A site-wide setting that stores the navigation menu structure using a StreamField. Registered as a Wagtail BaseSiteSetting accessible via Settings in the admin interface.
- **Menu Item**: Can be one of three types (StreamField blocks):
  - **Internal Page Link**: References a Wagtail page, optional custom title (with optional translations), optional anchor
  - **External URL Link**: Contains a URL, title (with optional translations), optional anchor
  - **Dropdown Menu**: Contains a title (with optional translations) and a list of child items (internal page links or external URL links ONLY - no nested dropdowns allowed)
- **Custom Title Translation**: Optional locale-text pairs for menu items. When provided, allows the menu item to display different text than the page title. When not provided, the page's own translated title is used.
- **Page**: Existing Wagtail page entity. Menu items can link to pages. Pages may have translations in multiple locales.
- **Locale**: Language/region configuration. Determines which page translations and custom title translations to use when rendering menus.

### Frontend Template Structure

- **navigation.html**: Main navigation component template that renders the complete menu structure with ARIA semantics, responsive layout, and theme support. Included in `base.html` for site-wide availability.
- **navigation_item.html**: Reusable template block for rendering simple menu links (both top-level and within dropdowns) with proper ARIA roles and active page indication.
- **navigation_dropdown.html**: Template block for rendering dropdown menus with `<details>`/`<summary>` elements, ARIA properties (`aria-haspopup`, `aria-controls`, `aria-labelledby`), and nested child items.
- **Skip Link**: Visually hidden anchor link positioned as first focusable element, allowing keyboard users to bypass navigation and jump to main content (WCAG 2.1 requirement).
- **Theme Classes**: DaisyUI theme-aware utility classes (e.g., `bg-base-100`, `text-base-content`) that automatically adapt to active theme (light/dark) without hardcoded colors.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Administrators can create a functional menu with 10 page links in under 5 minutes
- **SC-002**: Administrators can reorganize menu structure using up/down arrow controls and save changes in under 2 minutes
- **SC-003**: Visitors clicking menu items navigate to the correct page 100% of the time (no broken links)
- **SC-004**: Multi-lingual sites automatically display menus in the visitor's language with fallback to default locale for untranslated pages
- **SC-005**: Menu items linking to deleted pages are identified in the admin interface with clear warnings
- **SC-006**: Dropdown menus with child items display correctly without visual or functional issues
- **SC-007**: Dropdown menu titles successfully prevent navigation and only expand submenus when clicked
- **SC-008**: Menu rendering performance does not degrade perceptibly (< 100ms additional load time) with menus containing up to 50 items
- **SC-009**: 90% of administrators successfully create and publish a nested menu on first attempt without requiring support
- **SC-010**: Locale-specific menus automatically reflect page translation additions/removals within the same page load after save
- **SC-011**: Navigation menu passes WCAG 2.1 AA accessibility validation with zero critical errors (using axe DevTools or WAVE)
- **SC-012**: Keyboard-only users can navigate entire menu structure without mouse, completing all actions (open/close dropdowns, activate links)
- **SC-013**: Screen reader users receive proper context for all menu items (NVDA/JAWS announce item type, position, and expanded state)
- **SC-014**: Navigation menu automatically adapts to dark/light theme changes without requiring page reload or manual intervention
- **SC-015**: Mobile menu hamburger button has minimum 44x44 pixel touch target and clear focus indicator
- **SC-016**: All interactive menu elements meet 4.5:1 color contrast ratio for text and 3:1 for interactive components
- **SC-017**: Navigation remains functional with JavaScript disabled (dropdowns work via `<details>` element)
- **SC-018**: Users can activate skip link to bypass navigation and jump directly to main content using keyboard
- **SC-019**: Dropdown menus automatically position themselves to avoid viewport overflow (tested at viewport widths of 320px, 768px, 1024px, and 1920px)
- **SC-020**: Administrator receives clear validation error when attempting to nest dropdowns within dropdowns (3+ level prevention)
